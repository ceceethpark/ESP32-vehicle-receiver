# 운반차 수신기 프로젝트 개요

## 🎯 프로젝트 목적

ESP32 기반 운반차 수신기로서 리모컨 또는 로컬 버튼으로 차량을 제어하고, LCD로 상태를 표시하며, CAN 통신으로 STM32 기반 운반차 드라이버를 제어합니다.

## 📊 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    ESP32 차량 수신기                         │
│                    (이 프로젝트)                             │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  입력                    처리                  출력           │
│  ┌──────────┐       ┌──────────┐         ┌──────────┐      │
│  │리모컨    │──────→│  YbCar   │────────→│   LCD    │      │
│  │ESP-NOW   │       │  제어    │         │  상태표시 │      │
│  └──────────┘       │  로직    │         └──────────┘      │
│                     └──────────┘                             │
│  ┌──────────┐            ↓                ┌──────────┐      │
│  │로컬버튼  │            │                │ESP-NOW   │      │
│  │10개+ADC  │────────────┘                │상태송신  │      │
│  └──────────┘                             └──────────┘      │
│                                                   ↓           │
│                          CAN 통신                            │
│                             ↓                                │
└─────────────────────────────┼────────────────────────────────┘
                              ↓
                    ┌──────────────────┐
                    │  운반차 드라이버  │
                    │  (STM32 보드)    │
                    │  - 모터 제어     │
                    │  - 리프트/캐스트 │
                    │  - 센서 수집     │
                    └──────────────────┘
```

## 🔄 데이터 흐름

### 1. 제어 명령 흐름

#### 리모컨 모드
```
리모컨 버튼 입력
    ↓
ESP-NOW 수신 (onDataReceived)
    ↓
handleButtonCommand()
    ↓
YbCar 제어 함수 호출
    ↓
CAN 메시지 송신 → STM32 운반차 드라이버
```

#### 로컬 버튼 모드
```
로컬 버튼 입력 (GPIO/ADC)
    ↓
LocalButton.scan()
    ↓
LocalButton.processEvents()
    ↓
YbCar 제어 함수 호출
    ↓
CAN 메시지 송신 → STM32 운반차 드라이버
```

### 2. 상태 정보 흐름

```
STM32 운반차 드라이버
    ↓
CAN 메시지 수신 (센서 데이터)
    ↓
YbCar.update() - 상태 업데이트
    ├─→ LCD 표시 (0.5초 주기)
    └─→ ESP-NOW 송신 → 리모컨 (1초 주기)
```

## 🎮 제어 모드 전환

```
┌──────────────┐
│ 리모컨 모드  │ ◄────── ESP-NOW 신호 수신
└──────┬───────┘
       │
       │ 3초 타임아웃
       ↓
┌──────────────┐
│로컬 버튼 모드│
└──────┬───────┘
       │
       │ ESP-NOW 신호 재수신
       ↓
┌──────────────┐
│ 리모컨 모드  │
└──────────────┘
```

## 📋 주요 클래스

### 1. **YbCar** (차량 제어)
- 모터 제어: `moveForward()`, `moveBackward()`, `turnLeft()`, `turnRight()`, `stop()`
- 리프트 제어: `liftUp()`, `liftDown()`, `liftStop()`
- 캐스트 제어: `castUp()`, `castDown()`, `castStop()`
- 상태 관리: `update()`, `getSpeed()`, `getBatteryLevel()` 등

### 2. **LocalButton** (로컬 버튼 입력)
- 10개 버튼 입력 (전진/후진, 좌/우, 리프트, 캐스트, 비상정지, 운전)
- 3개 토글 스위치 (전진/후진, 리프트, 캐스트)
- 2개 ADC 입력 (스로틀, 속도제한)
- 디바운스 처리

### 3. **RemoteESPNow** (무선 통신)
- 리모컨 명령 수신
- 차량 상태 송신 (1초 주기)
- 양방향 통신 지원

### 4. **RemoteCANCom** (CAN 통신)
- STM32 운반차 드라이버 제어
- 500kbps 통신
- 센서 데이터 수신

### 5. **RemoteLCD** (LCD 표시)
- 차량 상태 실시간 표시 (0.5초 주기)
- 배터리, 속도, 온도, 전류 등
- 한글 폰트 지원

## 🔧 GPIO 핀 할당

| 기능 | GPIO | 설명 |
|------|------|------|
| **LCD** | | |
| - CS | 5 | Chip Select |
| - DC | 4 | Data/Command |
| - RST | 15 | Reset |
| - MOSI | 23 | SPI Data |
| - SCLK | 18 | SPI Clock |
| **CAN** | | |
| - TX | 21 | TWAI TX |
| - RX | 22 | TWAI RX |
| **로컬 버튼** | | |
| - 전진 | 32 | pIO_AN |
| - 후진 | 33 | pIO_AP |
| - 좌회전 | 25 | pIO_BN |
| - 우회전 | 26 | pIO_BP |
| - 리프트↑ | 27 | pIO_CN |
| - 리프트↓ | 14 | pIO_CP |
| - 캐스트↑ | 12 | pIO_DN |
| - 캐스트↓ | 13 | pIO_DP |
| - 비상정지 | 15 | pIO_1P |
| - 운전SW | 4 | pIO_1N |
| **ADC** | | |
| - 스로틀 | 34 | pAN0 |
| - 속도제한 | 35 | pAN1 |
| **기타** | | |
| - LED | 2 | 상태 표시 |

## 📦 데이터 구조

### ESP-NOW 메시지

#### 수신 (리모컨 → 차량)
```cpp
struct struct_message {
    uint8_t buttonId;      // 0-4 (SELECT/UP/DOWN/LEFT/RIGHT)
    uint8_t buttonState;   // 0:릴리스, 1:눌림
    uint32_t timestamp;    // 타임스탬프
};
```

#### 송신 (차량 → 리모컨)
```cpp
struct vehicle_message {
    uint8_t speed;         // 속도 (km/h)
    uint8_t direction;     // 0:정지, 1:전진, 2:후진
    uint8_t batteryLevel;  // 배터리 (%)
    int16_t motorTemp;     // 모터 온도 (°C)
    uint16_t motorCurrent; // 모터 전류 (mA)
    int16_t fetTemp;       // FET 온도 (°C)
    uint32_t timestamp;    // 타임스탬프
};
```

## 🔒 안전 기능

1. **비상 정지**: 언제든지 최우선 처리
2. **운전 스위치**: Foot switch - 안 눌러져 있으면 모든 동작 정지
3. **제어 모드 자동 전환**: 리모컨 신호 끊기면 로컬 버튼 모드로 자동 전환
4. **타임아웃**: 3초간 리모컨 신호 없으면 로컬 모드
5. **디바운스**: 버튼 채터링 방지 (50ms)

## 🚀 시작 순서

1. **전원 ON**
2. **LCD 초기화** → "차량 수신기" 표시
3. **로컬 버튼 초기화** → 10개 버튼 + 2개 ADC
4. **ESP-NOW 초기화** → MAC 주소 표시
5. **CAN 초기화** → 500kbps, STM32 연결
6. **YbCar 초기화** → 차량 제어 준비
7. **준비 완료** → LCD에 초기 상태 표시

## 📈 업데이트 주기

- **버튼 스캔**: 10ms (loop 딜레이)
- **LCD 업데이트**: 500ms (0.5초)
- **차량 상태 송신**: 1000ms (1초, 리모컨 모드만)
- **차량 상태 업데이트**: 10ms
- **디버그 출력**: 10000ms (10초)

## 🎯 사용 시나리오

### 시나리오 1: 리모컨 제어
1. 리모컨 전원 ON
2. ESP32가 신호 수신
3. 자동으로 리모컨 모드
4. 리모컨 버튼으로 제어
5. LCD에 상태 표시
6. 리모컨으로 상태 전송

### 시나리오 2: 로컬 버튼 제어
1. 리모컨 OFF 또는 거리 멀어짐
2. 3초 타임아웃
3. 자동으로 로컬 버튼 모드
4. 운전 스위치 누름
5. 전진/후진 토글 + 스로틀로 제어
6. LCD에 상태 표시

### 시나리오 3: 모드 전환
1. 로컬 버튼 모드 중
2. 리모컨 신호 수신
3. 즉시 리모컨 모드로 전환
4. 리모컨으로 제어 계속

## 🔧 확장 가능성

- **센서 추가**: I2C/ADC를 통한 추가 센서 통합
- **로깅**: SD 카드에 운행 기록 저장
- **무선 업데이트**: OTA 펌웨어 업데이트
- **블루투스**: BLE를 통한 설정 및 모니터링
- **추가 제어**: 더 많은 버튼/토글 추가 가능
